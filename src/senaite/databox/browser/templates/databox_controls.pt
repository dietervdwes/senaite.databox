<div i18n:domain="senaite.databox">

  <script type="text/javascript">
   document.addEventListener("DOMContentLoaded", () => {
     console.debug("*** SENAITE.DATABOX::DOMContentLoaded: --> Loading JS Controller");
     let btn = document.getElementById("add_column");
     let columns = document.getElementById("columns");
     $(columns).sortable();
     btn.addEventListener("click", (event) => {
       event.preventDefault();
       let nodes = columns.querySelectorAll("li.column");
       let last = nodes[nodes.length-1]
       columns.append(last.cloneNode(true));
     });
   });
  </script>

  <form name="databox-form"
        class="form"
        method="post"
        i18n:domain="senaite.core"
        enctype="multipart/form-data"
        tal:attributes="action string:${here/absolute_url}/@@update">

    <div class="form-row align-items-center">
      <!-- sort on -->
      <div class="col-auto">
        <div class="input-group mb-2">
          <div class="input-group-prepend">
            <div class="input-group-text">
              <span i18n:translate="">Sort on</span>
            </div>
          </div>
          <select class="form-control"
                  name="senaite.databox.sort_on">
            <tal:indexes repeat="index view/get_catalog_indexes">
              <option tal:attributes="value index; selected python:context.sort_on == index and 'selected' or ''">
                <span tal:replace="index"/>
              </option>
            </tal:indexes>
          </select>
        </div>
      </div>
      <!-- limit -->
      <div class="col-auto">
        <div class="input-group mb-2">
          <div class="input-group-prepend">
            <div class="input-group-text">
              <span i18n:translate="">Limit</span>
            </div>
          </div>
          <input type="number"
                 style="width:75px"
                 class="form-control"
                 id="field-limit"
                 tal:attributes="value here/limit"
                 min="1"
                 name="senaite.databox.limit:int">
        </div>
      </div>
      <!-- Reversed order -->
      <div class="col-auto">
        <div class="form-check mb-2">
          <input type="checkbox"
                 class="form-check-input"
                 id="field-sort_reversed"
                 tal:attributes="checked here/sort_reversed"
                 value="selected"
                 name="senaite.databox.sort_reversed:boolean">
          <label class="form-check-label" for="field-sort_reversed" i18n:translate="">
            Reversed order
          </label>
        </div>
      </div>
    </div>

    <!-- Custom Edit View -->
    <ul id="columns" class="columns my-4 list-unstyled">

      <li class="column d-flex flex-wrap p-0 mb-2"
          tal:define="columns view/columns"
          tal:repeat="column columns">

        <!-- Column -->
        <div class="flex-fill mr-2">
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span i18n:translate="">Column</span>
              </div>
            </div>
            <select class="form-control"
                    name="senaite.databox.columns.column:records">
              <tal:indexes repeat="field view/get_schema_fields">
                <option tal:attributes="value field; selected python:field == column and 'selected' or ''">
                  <span tal:replace="field"/>
                </option>
              </tal:indexes>
            </select>
          </div>
        </div>

        <!-- Column Title -->
        <div class="flex-fill mr-2">
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span i18n:translate="">Title</span>
              </div>
            </div>
            <input type="text"
                  class="form-control"
                  tal:attributes="value column/title"
                  name="senaite.databox.columns.title:records">
          </div>
        </div>

        <!-- REF -->
        <div class="flex-fill mr-2"
             tal:repeat="ref python:view.get_refs_for(column)">
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span i18n:translate="">Reference</span>
              </div>
            </div>
            <select class="form-control"
                    name="senaite.databox.columns.refs:list:records">
              <tal:keys repeat="key ref/fields">
                <option tal:attributes="value key; selected python:key == ref.get('key') and 'selected' or ''">
                  <span tal:replace="key"/>
                </option>
              </tal:keys>
            </select>
          </div>
        </div>

        <!-- Column Converter -->
        <div class="flex-fill mr-2">
          <div class="input-group mb-2">
            <div class="input-group-prepend">
              <div class="input-group-text">
                <span i18n:translate="">Converter</span>
              </div>
            </div>
            <select class="form-control"
                    name="senaite.databox.columns.converter:records">
              <tal:indexes repeat="converter view/get_converters">
                <option tal:define="name converter/name; description converter/description"
                        tal:attributes="value name;
                                        label converter/description;
                                        selected python:name == columns[column].get('converter') and 'selected' or ''">
                  <span tal:replace="name"/>
                </option>
              </tal:indexes>
            </select>
          </div>
        </div>
      </li>
    </ul>
    <!-- More button -->
    <button id="add_column" class="btn btn-sm btn-outline-secondary" i18n:translate="">More</button>

    <!-- hidden fields -->
    <input type="hidden" name="submitted" value="1" />
    <input tal:replace="structure context/@@authenticator/authenticator"/>

    <!-- !TEMPORARY DEACTIVATED!
         ReactJS managed component -->
    <div tal:condition="python:False"
         class="databox"
         tal:attributes="view/settings">
    </div>
    <!-- /ReactJS managed component -->

    <!-- submit -->
    <input class="btn btn-sm btn-primary" type="submit" name="form.buttons.save" value="Update" />
  </form>

</div>
